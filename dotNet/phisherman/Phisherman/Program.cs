using System;
using System.Collections.ObjectModel;
using System.Diagnostics;
using System.Security.Principal;
using System.Threading;
using AutoIt;
using Microsoft.Exchange.WebServices.Data;

namespace Phisherman
{
	// Token: 0x02000007 RID: 7
	internal class Program
	{
		// Token: 0x06000011 RID: 17 RVA: 0x00002940 File Offset: 0x00000B40
		private static void Main(string[] args)
		{
			string emailAddress = WindowsIdentity.GetCurrent().Name.Split(new char[]
			{
				'\\'
			})[1] + "@rastalabs.local";
			ExchangeService exchangeService = Exchange.GetExchangeService();
			for (;;)
			{
				Collection<ItemId> newEmailItemIds = Email.GetNewEmailItemIds(exchangeService, 4);
				if (newEmailItemIds.Count > 0)
				{
					Phish.Catch(exchangeService, newEmailItemIds, emailAddress);
					Thread.Sleep(500);
					Email.DeleteEmailBatch(exchangeService, newEmailItemIds);
				}
				Collection<ItemId> newEmailItemIds2 = Email.GetNewEmailItemIds(exchangeService, 8);
				if (newEmailItemIds2.Count > 0)
				{
					Email.DeleteEmailBatch(exchangeService, newEmailItemIds2);
				}
				Collection<ItemId> newEmailItemIds3 = Email.GetNewEmailItemIds(exchangeService, 3);
				if (newEmailItemIds3.Count > 0)
				{
					Email.DeleteEmailBatch(exchangeService, newEmailItemIds3);
				}
				Program.CloseWindows();
				Thread.Sleep(30000);
			}
		}

		// Token: 0x06000012 RID: 18 RVA: 0x000029E8 File Offset: 0x00000BE8
		private static void CloseWindows()
		{
			try
			{
				Process[] processesByName = Process.GetProcessesByName("iexplore");
				for (int i = 0; i < processesByName.Length; i++)
				{
					processesByName[i].Kill();
				}
				processesByName = Process.GetProcessesByName("mshta");
				for (int i = 0; i < processesByName.Length; i++)
				{
					processesByName[i].Kill();
				}
				AutoItX.WinActivate("Windows PowerShell credential request", "");
				if (AutoItX.WinWaitActive("Windows PowerShell credential request", "", 5) != 0)
				{
					AutoItX.Send("{ESC}", 0);
				}
				AutoItX.WinActivate("Windows Features", "");
				if (AutoItX.WinWaitActive("Windows Features", "", 5) != 0)
				{
					AutoItX.Send("!{f4}", 0);
				}
			}
			catch (Exception ex)
			{
				Debug.Log("CloseWindows", ex.Message);
			}
		}
	}
}
